<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Chat</title>
    <script src="https://unpkg.com/htmx.org"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: white;
        }

        /* Chat button styling */
        #chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, {{ bot.color_1 }}, {{ bot.color_2 }});
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
        z-index: 1001;
        transition: transform 0.3s ease,
        box-shadow 0.3s ease,
        opacity 0.3s ease;
        }

        #chat-button:hover {
            transform: scale(1.05);
            box-shadow: 0px 6px 15px rgba(0, 0, 0, 0.4);
        }

        #chat-button.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 500px;
            background-color: #ffffff;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            /* Initial state - hidden */
            transform: translateY(calc(100% + 20px));
            opacity: 0;
            transition: transform 0.4s ease, opacity 0.3s ease;
        }

        /* Active state for chat container */
        #chat-container.active {
            transform: translateY(0);
            opacity: 1;
        }

        /* Chat header */
        .chat-header {
            height: 64px;

            border-bottom: 1px solid {
                    {
                    bot.color_1
                }
            }

            ;
            display: flex;
            align-items: center;
            padding: 0 16px;

           background: linear-gradient(135deg, {{ bot.color_1 }}, {{ bot.color_2 }});
        flex-shrink: 0;
        justify-content: space-between;
        }

        /* Close button in header */
        .close-chat {
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            transition: background-color 0.2s ease;
        }

        .close-chat:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        /* Chat window - scrollable area */
        #chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scroll-behavior: smooth;
            background-color: #f7f7f7;
        }

        /* Typing animation */
        #typing-animation {
            padding: 8px 16px;
            margin-bottom: 8px;
        }

        /* Input area - fixed at bottom */
        #chat-form {
            border-top: 1px solid #f0f0f0;
            padding: 12px;
            background-color: #f0f0f0;
            flex-shrink: 0;
            color: black;
        }

        .cs-btn-css {
            background: linear-gradient(135deg, {{ bot.color_1 }}, {{ bot.color_2 }});

        color: white;
        }

        /* Message styling */
        .message-container {
            margin-bottom: 12px;
        }

        /* User message */
        .message-container-user {
            align-self: flex-end;

            background: linear-gradient(135deg, {{ bot.color_1 }}, {{ bot.color_2 }});

        padding: 12px 16px;
        margin: 6px 10px;
        border-radius: 14px 14px 4px 14px;
        /* Adjusted for a better look */
        max-width: 75%;
        font-size: 14px;
        word-wrap: break-word;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.15);
        display: inline-block;
        position: relative;
        }


        /* Typing animation dots */
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6228d7, #ff00ee);
            display: inline-block;
            margin: 0 2px;
        }

        .typing-dot:nth-child(1) {
            animation: bounce 1s infinite;
        }

        .typing-dot:nth-child(2) {
            animation: bounce 1s infinite 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation: bounce 1s infinite 0.4s;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-6px);
            }
        }


        .bot-message {
            background: linear-gradient(135deg, {{ bot.color_1 }}, {{ bot.color_2 }});


        color: {{bot.text_color}};
        border-radius: 18px 18px 18px 4px;
        padding: 10px 14px;
        max-width: 50%;
        word-wrap: break-word;
        }
    </style>
</head>

<body class="text-white">
    <!-- Chat button -->
    <div id="chat-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
    </div>

    <!-- Chat container -->
    <div id="chat-container">
        <div class="chat-header">
            <div class="flex items-center">
                <div class="text-black w-10 h-10 rounded-full bg-white flex items-center justify-center">
                    <span>{{ bot.bot_name.0 }}</span>
                </div>
                <span class="ml-3 font-medium">{{bot.bot_name}}</span>
            </div>
            <div class="close-chat">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </div>
        </div>
        <div id="chat-window" class="flex-1 overflow-y-auto space-y-4">

        </div>
        <div id="typing-animation" class="hidden">
            <div class="flex items-center space-x-2 bg-white rounded-lg p-3 shadow-sm max-w-[100px]">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        <form id="chat-form" class="border-t border-zinc-800 p-4 bg-zinc-900">
            <div class="flex items-center space-x-4">
                <input type="text" id="user-input" name="query" placeholder="Type a message..."
                    class="flex-1 cs-input rounded-lg px-4 py-3 focus:outline-none focus:ring-2 " required>
               <button 
                    type="button" 
                    onclick="sendMessage(document.getElementById('user-input').value, 'user')" 
                    class="cs-btn-css hover:bg-zinc-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    Send
                </button>

            </div>
        </form>
    </div>
    <script>
        const chatWindow = document.getElementById("chat-window");
        var global_chat_id = null;
        document.addEventListener("DOMContentLoaded", async () => {
            const bot_id = "{{bot.uuid}}"
            try {
                var ip_address = await fetch("https://api64.ipify.org?format=json")
                var ip_address = await ip_address.json()
                var ip_address = ip_address["ip"]
                const res = await fetch(`http://127.0.0.1:8000/bot/create-supabase-chat`,
                    {
                        method: 'POST',
                        body: JSON.stringify({
                            "ip_address": ip_address,
                            "bot_id": bot_id
                        })
                    })
                const chat_id_getter = await res.json()
                const chat_id = chat_id_getter["chat"]["id"]
                global_chat_id = chat_id
                var chat_messages = await fetch(`http://127.0.0.1:8000/bot/get-messages/${chat_id}`)
                var chat_messages = await chat_messages.json()
                var chat_messages = chat_messages["messages"]
                chat_messages.forEach(
                    msg => {
                        const div = document.createElement("div");
                        if (msg.sender === "bot") {
                            div.className = "bot-message";
                        } else if (msg.sender === "user") {
                            div.className = "message-container-user";
                        }
                        div.textContent = msg.chat_messages;
                        chatWindow.appendChild(div);
                    }
                )
            }
            catch (err) {
                console.log(err)
            }
        })

        async function sendMessage(message, sender) {
            await fetch(`http://127.0.0.1:8000/bot/send-message`, {
                body: JSON.stringify({
                    "chat_id" : global_chat_id,
                    "message" : message,
                    "sender" : sender
                })
            })
            const div = document.createElement("div");
            if (sender === "bot") {
                            div.className = "bot-message";
                        } else if (sender === "user") {
                            div.className = "message-container-user";
                        }
            div.textContent = message;
            chatWindow.appendChild(div);
        }

        function scrollToBottom() {
            let chatWindow = document.getElementById("chat-window");
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showTypingAnimation() {
            document.getElementById("typing-animation").classList.remove("hidden");
            scrollToBottom();
        }

        function hideTypingAnimation() {
            document.getElementById("typing-animation").classList.add("hidden");
        }



        // Toggle chat window visibility
        function toggleChat() {
            const chatContainer = document.getElementById("chat-container");
            const chatButton = document.getElementById("chat-button");
            chatContainer.classList.toggle("active");
            chatButton.classList.toggle("hidden");

            // If opening the chat, scroll to bottom
            if (chatContainer.classList.contains("active")) {
                setTimeout(scrollToBottom, 400); // Wait for animation to complete
            }
        }



        // Event listeners for chat button and close button
        document.getElementById("chat-button").addEventListener("click", toggleChat);
        document.querySelector(".close-chat").addEventListener("click", toggleChat);

        document.getElementById("chat-form").addEventListener("submit", function (event) {
            event.preventDefault();

        });
    </script>
</body>

</html>